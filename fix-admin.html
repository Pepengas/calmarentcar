<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Fix - Calma Car Rental</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #0066cc;
            margin-bottom: 20px;
        }
        .section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section-title {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0055aa;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #333;
            color: #fff;
            font-family: monospace;
            border-radius: 4px;
            margin-top: 15px;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .warning {
            color: #ffc107;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <h1>Admin Dashboard Diagnostic & Fix Tool</h1>
    
    <div class="section">
        <h2 class="section-title">Diagnostic Tools</h2>
        <p>Use these tools to diagnose issues with the admin dashboard:</p>
        <div>
            <button id="check-storage">Check localStorage</button>
            <button id="check-admin-dashboard">Check Admin Dashboard</button>
            <button id="run-all-diagnostics">Run All Diagnostics</button>
        </div>
    </div>
    
    <div class="section">
        <h2 class="section-title">Fix Tools</h2>
        <p>Use these tools to fix issues with the admin dashboard:</p>
        <div>
            <button id="add-test-booking">Add Test Booking</button>
            <button id="clear-bookings">Clear All Bookings</button>
            <button id="reload-dashboard">Reload Dashboard Script</button>
        </div>
    </div>
    
    <div class="section">
        <h2 class="section-title">Bookings</h2>
        <div id="bookings-container">Loading bookings...</div>
    </div>
    
    <div class="section">
        <h2 class="section-title">Log</h2>
        <div class="log" id="log"></div>
    </div>
    
    <script>
        // Utility functions
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function displayBookings() {
            const container = document.getElementById('bookings-container');
            
            try {
                const bookingsData = localStorage.getItem('adminBookings');
                if (!bookingsData) {
                    container.innerHTML = '<p>No bookings found in localStorage.</p>';
                    return;
                }
                
                const bookings = JSON.parse(bookingsData);
                if (!Array.isArray(bookings) || bookings.length === 0) {
                    container.innerHTML = '<p>No bookings found in localStorage.</p>';
                    return;
                }
                
                let html = `<p>Found ${bookings.length} bookings:</p>`;
                html += '<ul>';
                
                bookings.forEach((booking, index) => {
                    const customer = booking.customer || {};
                    const car = booking.selectedCar || {};
                    
                    html += `
                        <li>
                            <strong>Booking #${booking.bookingReference || 'N/A'}</strong> - 
                            Status: ${booking.status || 'N/A'}<br>
                            Customer: ${customer.firstName || ''} ${customer.lastName || ''}<br>
                            Car: ${car.make || ''} ${car.model || ''}<br>
                            Date: ${new Date(booking.timestamp || booking.dateSubmitted || Date.now()).toLocaleString()}
                        </li>
                    `;
                });
                
                html += '</ul>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = `<p class="error">Error displaying bookings: ${e.message}</p>`;
                log(`Error displaying bookings: ${e.message}`, 'error');
            }
        }
        
        // Diagnostic functions
        function checkLocalStorage() {
            log('Checking localStorage...', 'info');
            
            try {
                // Test write
                const testKey = 'calma_test_' + Date.now();
                localStorage.setItem(testKey, 'test_value');
                
                // Test read
                const readValue = localStorage.getItem(testKey);
                if (readValue !== 'test_value') {
                    log('localStorage read/write test failed!', 'error');
                    return false;
                }
                
                // Clean up
                localStorage.removeItem(testKey);
                
                log('localStorage is working correctly', 'success');
                return true;
            } catch (e) {
                log(`localStorage is not available: ${e.message}`, 'error');
                return false;
            }
        }
        
        function checkAdminDashboard() {
            log('Checking if AdminDashboard is available...', 'info');
            
            try {
                // Check if AdminDashboard is defined
                if (typeof window.AdminDashboard === 'undefined') {
                    log('AdminDashboard is not defined!', 'error');
                    return false;
                }
                
                // Check if necessary methods exist
                if (typeof window.AdminDashboard.init !== 'function') {
                    log('AdminDashboard.init is not a function!', 'error');
                    return false;
                }
                
                if (typeof window.AdminDashboard.refreshData !== 'function') {
                    log('AdminDashboard.refreshData is not a function!', 'error');
                    return false;
                }
                
                log('AdminDashboard is available and has all required methods', 'success');
                return true;
            } catch (e) {
                log(`Error checking AdminDashboard: ${e.message}`, 'error');
                return false;
            }
        }
        
        function runAllDiagnostics() {
            log('Running all diagnostics...', 'info');
            
            const storageOk = checkLocalStorage();
            displayBookings();
            
            try {
                // Try to check if admin dashboard is available
                const dashboardOk = checkAdminDashboard();
                
                if (storageOk && dashboardOk) {
                    log('All diagnostics passed!', 'success');
                } else {
                    log('Some diagnostics failed. See the log for details.', 'warning');
                }
            } catch (e) {
                log(`Error running diagnostics: ${e.message}`, 'error');
            }
        }
        
        // Fix functions
        function addTestBooking() {
            log('Adding test booking...', 'info');
            
            try {
                // Create test booking data
                const testBooking = {
                    bookingReference: 'TEST-' + Math.floor(Math.random() * 10000),
                    status: 'confirmed',
                    timestamp: new Date().toISOString(),
                    dateSubmitted: new Date().toISOString(),
                    customer: {
                        firstName: 'Test',
                        lastName: 'User',
                        email: 'test@example.com',
                        phone: '+1234567890',
                        additionalOptions: {
                            fullInsurance: true,
                            gpsNavigation: true
                        }
                    },
                    selectedCar: {
                        make: 'Toyota',
                        model: 'Corolla',
                        price: 45
                    },
                    pickupLocation: 'airport',
                    dropoffLocation: 'port',
                    pickupDate: new Date().toISOString(),
                    returnDate: new Date(Date.now() + 3*24*60*60*1000).toISOString(),
                    durationDays: 3,
                    totalPrice: 135
                };
                
                // Get existing bookings
                let adminBookings = [];
                const existingData = localStorage.getItem('adminBookings');
                
                if (existingData) {
                    try {
                        adminBookings = JSON.parse(existingData);
                        log(`Found ${adminBookings.length} existing bookings`, 'info');
                    } catch (e) {
                        log(`Error parsing existing bookings: ${e.message}`, 'error');
                    }
                }
                
                // Add new booking
                adminBookings.push(testBooking);
                
                // Sort bookings by timestamp (newest first)
                adminBookings.sort((a, b) => {
                    const dateA = a.timestamp || a.dateSubmitted || '1970-01-01';
                    const dateB = b.timestamp || b.dateSubmitted || '1970-01-01';
                    return new Date(dateB) - new Date(dateA);
                });
                
                // Save to localStorage
                localStorage.setItem('adminBookings', JSON.stringify(adminBookings));
                
                log(`Test booking #${testBooking.bookingReference} added successfully`, 'success');
                
                // Refresh display
                displayBookings();
                
                // Attempt to refresh dashboard if available
                if (typeof window.AdminDashboard !== 'undefined' && 
                    typeof window.AdminDashboard.refreshData === 'function') {
                    window.AdminDashboard.refreshData();
                    log('Refreshed AdminDashboard with new data', 'success');
                }
                
                return true;
            } catch (e) {
                log(`Error adding test booking: ${e.message}`, 'error');
                return false;
            }
        }
        
        function clearAllBookings() {
            if (confirm('Are you sure you want to clear all bookings? This cannot be undone.')) {
                try {
                    localStorage.removeItem('adminBookings');
                    log('All bookings have been cleared', 'success');
                    displayBookings();
                    
                    // Attempt to refresh dashboard if available
                    if (typeof window.AdminDashboard !== 'undefined' && 
                        typeof window.AdminDashboard.refreshData === 'function') {
                        window.AdminDashboard.refreshData();
                        log('Refreshed AdminDashboard with empty data', 'success');
                    }
                    
                    return true;
                } catch (e) {
                    log(`Error clearing bookings: ${e.message}`, 'error');
                    return false;
                }
            }
        }
        
        function reloadDashboardScript() {
            log('Reloading AdminDashboard script...', 'info');
            
            try {
                // Create a new script element
                const script = document.createElement('script');
                script.src = 'js/admin-dashboard.js?nocache=' + Date.now();
                
                // Add load event
                script.onload = function() {
                    log('AdminDashboard script loaded successfully', 'success');
                    
                    // Initialize if available
                    if (typeof window.AdminDashboard !== 'undefined' && 
                        typeof window.AdminDashboard.init === 'function') {
                        window.AdminDashboard.init();
                        log('AdminDashboard initialized successfully', 'success');
                    } else {
                        log('AdminDashboard could not be initialized', 'error');
                    }
                };
                
                // Add error event
                script.onerror = function() {
                    log('Failed to load AdminDashboard script', 'error');
                };
                
                // Append to document
                document.body.appendChild(script);
            } catch (e) {
                log(`Error reloading dashboard script: ${e.message}`, 'error');
            }
        }
        
        // Set up event listeners
        document.getElementById('check-storage').addEventListener('click', checkLocalStorage);
        document.getElementById('check-admin-dashboard').addEventListener('click', checkAdminDashboard);
        document.getElementById('run-all-diagnostics').addEventListener('click', runAllDiagnostics);
        document.getElementById('add-test-booking').addEventListener('click', addTestBooking);
        document.getElementById('clear-bookings').addEventListener('click', clearAllBookings);
        document.getElementById('reload-dashboard').addEventListener('click', reloadDashboardScript);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Diagnostic tool loaded', 'info');
            displayBookings();
        });
    </script>
    
    <!-- Try to load admin dashboard script for testing -->
    <script src="js/admin-dashboard.js?nocache=1"></script>
</body>
</html> 