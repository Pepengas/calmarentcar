<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Information - Calma Car Rental</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Add Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      color: #333;
      line-height: 1.5;
      background-color: #fff;
    }
    
    /* Header */
    header {
      border-bottom: 1px solid #eee;
      padding: 1rem 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-weight: 600;
    }
    
    .logo a {
      color: #333;
      text-decoration: none;
    }
    
    .nav-menu {
      display: flex;
      list-style: none;
    }
    
    .nav-menu li {
      margin-left: 1.5rem;
    }
    
    .nav-menu a {
      color: #333;
      text-decoration: none;
      font-size: 0.95rem;
    }
    
    /* Main content */
    .content {
      padding: 2.5rem 0;
    }
    
    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      color: #0066cc;
      text-decoration: none;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }
    
    .back-link::before {
      content: "←";
      margin-right: 0.5rem;
    }

    /* Progress indicator */
    .progress-steps {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    
    .step {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background-color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin: 0 0.5rem;
      position: relative;
    }
    
    .step.completed {
      background-color: #0066cc;
      color: white;
    }
    
    .step.active {
      background-color: #0066cc;
      color: white;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }
    
    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      right: -30px;
      top: 50%;
      width: 30px;
      height: 2px;
      background-color: #eee;
    }
    
    .step.completed:not(:last-child)::after {
      background-color: #0066cc;
    }
    
    .step-titles {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .step-title {
      width: 120px;
      font-size: 0.8rem;
      color: #999;
      margin: 0 0.5rem;
    }
    
    .step-title.active {
      font-weight: 600;
      color: #333;
    }
    
    /* Booking summary */
    #booking-summary {
      background-color: #f8f9fa;
      border-left: 4px solid #0066cc;
      padding: 1.5rem;
      border-radius: 4px;
      margin-bottom: 2rem;
    }
    
    .summary-title {
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .summary-label {
      font-weight: 600;
    }
    
    /* Selected car */
    .selected-car {
      display: flex;
      background-color: white;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .selected-car-image {
      width: 80px;
      height: 60px;
      margin-right: 1rem;
    }
    
    .selected-car-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .selected-car-details h4 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .selected-car-details .car-category {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    
    /* Form styles */
    .personal-info-form {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .form-header {
      background-color: #f8f9fa;
      padding: 1.25rem;
      border-bottom: 1px solid #eee;
    }
    
    .form-header h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }
    
    .form-body {
      padding: 1.5rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-group.full-width {
      grid-column: span 2;
    }
    
    .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .form-group label.required::after {
      content: '*';
      color: #e51c23;
      margin-left: 0.25rem;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: #0066cc;
      outline: none;
    }
    
    .form-group .hint {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }
    
    .form-group .validation-message {
      font-size: 0.8rem;
      color: #e51c23;
      margin-top: 0.5rem;
      min-height: 20px;
    }
    
    .form-group.error input,
    .form-group.error textarea,
    .form-group.error select {
      border-color: #e51c23;
    }
    
    .form-check {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .form-check input[type="checkbox"] {
      margin-right: 0.5rem;
      margin-top: 0.25rem;
      width: auto;
    }
    
    .form-actions {
      display: flex;
      justify-content: space-between;
      padding: 1.25rem;
      border-top: 1px solid #eee;
      background-color: #f8f9fa;
    }
    
    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s;
      border: none;
      font-size: 0.95rem;
    }
    
    .btn-primary {
      background-color: #0066cc;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #0055aa;
    }
    
    .btn-secondary {
      background-color: #f2f2f2;
      color: #333;
    }
    
    .btn-secondary:hover {
      background-color: #e6e6e6;
    }
    
    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 3rem 0;
      color: #666;
    }
    
    /* Notification container */
    #notification-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .notification {
      background-color: white;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      margin-bottom: 10px;
      transform: translateX(100%);
      animation: slide-in 0.3s forwards;
    }
    
    .notification.success {
      border-left: 4px solid #4CAF50;
    }
    
    .notification.error {
      border-left: 4px solid #e51c23;
    }
    
    .notification.fade-out {
      animation: fade-out 0.3s forwards;
    }
    
    @keyframes slide-in {
      100% { transform: translateX(0); }
    }
    
    @keyframes fade-out {
      0% { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(100%); }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-group.full-width {
        grid-column: span 1;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .form-actions .btn {
        width: 100%;
        margin-bottom: 0.75rem;
      }
      
      .form-actions .btn:last-child {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <a href="index.html">Calma Car Rental</a>
        </div>
        <nav>
          <ul class="nav-menu">
            <li><a href="index.html">Home</a></li>
            <li><a href="#">Our Fleet</a></li>
            <li><a href="#">Book Now</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <div class="container content">
    <h1>Personal Information</h1>
    
    <a href="car-selection.html" class="back-link">Back to car selection</a>
    
    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step completed" data-step="1">1</div>
      <div class="step completed" data-step="2">2</div>
      <div class="step active" data-step="3">3</div>
    </div>
    
    <div class="step-titles">
      <div class="step-title">Trip Details</div>
      <div class="step-title">Vehicle Selection</div>
      <div class="step-title active">Personal Information</div>
    </div>
    
    <!-- Booking Summary -->
    <div id="booking-summary">
      <div class="summary-title">Your Trip Details</div>
      <!-- Summary content will be populated by JavaScript -->
    </div>
    
    <!-- Personal Information Form -->
    <form id="personal-info-form" class="personal-info-form">
      <div class="form-header">
        <h2>Enter Your Details</h2>
      </div>
      
      <div class="form-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="required">First Name</label>
            <input type="text" id="first-name" name="first-name" required>
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group">
            <label class="required">Last Name</label>
            <input type="text" id="last-name" name="last-name" required>
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group">
            <label class="required">Email Address</label>
            <input type="email" id="email" name="email" required>
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group">
            <label class="required">Phone Number</label>
            <input type="tel" id="phone" name="phone" required>
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group">
            <label class="required">Date of Birth</label>
            <input type="date" id="dob" name="dob" required>
            <div class="validation-message"></div>
            <div class="hint">You must be at least 21 years old to rent a car.</div>
          </div>
          
          <div class="form-group">
            <label>Driver's License Number</label>
            <input type="text" id="license" name="license">
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group full-width">
            <label>Flight Number (if applicable)</label>
            <input type="text" id="flight" name="flight" placeholder="For airport pickup">
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group full-width">
            <label>Special Requests</label>
            <textarea id="requests" name="requests" rows="3"></textarea>
            <div class="validation-message"></div>
          </div>
        </div>
        
        <div class="form-check">
          <input type="checkbox" id="terms" name="terms" required>
          <label for="terms">I agree to the <a href="#">Terms and Conditions</a> and <a href="#">Privacy Policy</a></label>
        </div>
        <div class="validation-message" id="terms-error"></div>
      </div>
      
      <div class="form-actions">
        <button type="button" id="back-btn" class="btn btn-secondary">Back</button>
        <div class="form-group form-submit">
          <button type="submit" class="btn-primary">
            Proceed to Payment <i class="fas fa-credit-card"></i>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get booking details from URL parameters
      const pickupLocation = urlParams.get('pickup-location');
      const dropoffLocation = urlParams.get('dropoff-location');
      const pickupDate = urlParams.get('pickup-date');
      const pickupTime = urlParams.get('pickup-time');
      const dropoffDate = urlParams.get('dropoff-date');
      const dropoffTime = urlParams.get('dropoff-time');
      const duration = parseInt(urlParams.get('duration') || '1');
      const carId = urlParams.get('car-id');
      const carName = urlParams.get('car-name');
      const carPrice = parseFloat(urlParams.get('car-price') || '0');
      
      // Format locations
      function formatLocation(locationCode) {
        const locations = {
          'airport': 'Chania Airport',
          'port': 'Chania Port',
          'city': 'Chania City Center',
          'hotel': 'Your Hotel/Villa'
        };
        
        return locations[locationCode] || locationCode;
      }
      
      // Format dates
      function formatDate(dateStr) {
        if (!dateStr) return '';
        
        const parts = dateStr.split('/');
        if (parts.length !== 3) return dateStr;
        
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
        
        const month = parseInt(parts[0]) - 1;
        const day = parseInt(parts[1]);
        const year = parseInt(parts[2]);
        
        return `${months[month]} ${day}, ${year}`;
      }
      
      // Get car image based on ID
      function getCarImage(carId) {
        // For the new structure, handle string IDs like "aygo", "tiguan", etc.
        if (typeof carId === 'string') {
          return `https://calmarental.com/images/Calma${carId.charAt(0).toUpperCase() + carId.slice(1)}.jpg`;
        }
        
        // Handle numeric IDs (legacy support)
        const carImages = {
          '1': 'images/CalmaAygo.jpg',
          '2': 'images/Calmai10.jpg',
          '3': 'images/CalmaCitroen.jpg',
          '4': 'images/CalmaSuzuki.jpg',
          '5': 'images/CalmaGolf.jpg',
          '6': 'images/CalmaTiguan.jpg'
        };
        
        return carImages[carId] || 'images/CalmaLogo.jpg';
      }
      
      // Display booking summary
      const summaryContainer = document.getElementById('booking-summary');
      if (summaryContainer) {
        const totalPrice = carPrice * duration;
        
        summaryContainer.innerHTML = `
          <div class="summary-title">Your Trip Details</div>
          <div class="summary-item">
            <span class="summary-label">Pickup:</span>
            <span class="summary-value">${formatLocation(pickupLocation)} - ${formatDate(pickupDate)} at ${pickupTime}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Return:</span>
            <span class="summary-value">${formatLocation(dropoffLocation)} - ${formatDate(dropoffDate)} at ${dropoffTime}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Duration:</span>
            <span class="summary-value">${duration} ${duration === 1 ? 'day' : 'days'}</span>
          </div>
          <div class="selected-car">
            <div class="selected-car-image">
              <img src="${getCarImage(carId)}" alt="${carName}" onerror="this.src='images/CalmaLogo.jpg'">
            </div>
            <div class="selected-car-details">
              <h4>${carName}</h4>
              <div class="car-category">€${carPrice} per day</div>
              <div class="total-price">Total: €${totalPrice.toFixed(2)}</div>
            </div>
          </div>
        `;
      }
      
      // Handle form submission
      const form = document.getElementById('personal-info-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Validate form
          const firstName = document.getElementById('first-name').value;
          const lastName = document.getElementById('last-name').value;
          const email = document.getElementById('email').value;
          const phone = document.getElementById('phone').value;
          const dob = document.getElementById('dob').value;
          const license = document.getElementById('license').value;
          const flight = document.getElementById('flight').value;
          const requests = document.getElementById('requests').value;
          const terms = document.getElementById('terms').checked;
          
          let isValid = true;
          
          // Basic validation
          if (!firstName) {
            isValid = false;
            document.getElementById('first-name').closest('.form-group').classList.add('error');
            document.getElementById('first-name').closest('.form-group').querySelector('.validation-message').textContent = 'First name is required';
          }
          
          if (!lastName) {
            isValid = false;
            document.getElementById('last-name').closest('.form-group').classList.add('error');
            document.getElementById('last-name').closest('.form-group').querySelector('.validation-message').textContent = 'Last name is required';
          }
          
          if (!email) {
            isValid = false;
            document.getElementById('email').closest('.form-group').classList.add('error');
            document.getElementById('email').closest('.form-group').querySelector('.validation-message').textContent = 'Email is required';
          } else if (!email.includes('@')) {
            isValid = false;
            document.getElementById('email').closest('.form-group').classList.add('error');
            document.getElementById('email').closest('.form-group').querySelector('.validation-message').textContent = 'Please enter a valid email';
          }
          
          if (!phone) {
            isValid = false;
            document.getElementById('phone').closest('.form-group').classList.add('error');
            document.getElementById('phone').closest('.form-group').querySelector('.validation-message').textContent = 'Phone number is required';
          }
          
          if (!dob) {
            isValid = false;
            document.getElementById('dob').closest('.form-group').classList.add('error');
            document.getElementById('dob').closest('.form-group').querySelector('.validation-message').textContent = 'Date of birth is required';
          } else {
            // Check if the user is at least 21 years old
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
              age--;
            }
            
            if (age < 21) {
              isValid = false;
              document.getElementById('dob').closest('.form-group').classList.add('error');
              document.getElementById('dob').closest('.form-group').querySelector('.validation-message').textContent = 'You must be at least 21 years old to rent a car';
            }
          }
          
          if (!terms) {
            isValid = false;
            document.getElementById('terms-error').textContent = 'You must accept the terms and conditions';
          }
          
          if (isValid) {
            // Create booking object to store in localStorage
            const bookingId = generateBookingId();
            const totalPrice = carPrice * duration;
            
            // Customer info
            const customer_name = `${firstName} ${lastName}`;
            const customer_email = email;
            const customer_phone = phone;
            
            // Create a booking object compatible with admin panel
            const booking = {
              id: bookingId,
              customer_name: customer_name,
              customer_email: email,
              customer_phone: phone,
              car_name: carName,
              car_id: carId,
              pickup_date: pickupDate,
              pickup_time: pickupTime,
              pickup_location: pickupLocation,
              dropoff_date: dropoffDate,
              dropoff_time: dropoffTime,
              dropoff_location: dropoffLocation,
              status: 'pending',
              created_at: new Date().toISOString(),
              total_price: totalPrice,
              duration: duration,
              customer_details: {
                firstName: firstName,
                lastName: lastName,
                dob: dob,
                license: license,
                flight: flight,
                requests: requests
              }
            };
            
            // Save booking to localStorage
            saveBookingToLocalStorage(booking);
            
            // Update admin stats
            updateAdminStats();
            
            // Show success message
            showNotification('Your booking has been confirmed. A confirmation email has been sent to your email address.', 'success');
            
            // Disable the submit button to prevent double submission
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('submit-btn').textContent = 'Processing...';
            
            // Redirect to a confirmation page after a short delay
            setTimeout(() => {
              window.location.href = 'booking-confirmation.html?' + urlParams.toString() + 
                `&first-name=${encodeURIComponent(firstName)}` + 
                `&last-name=${encodeURIComponent(lastName)}` + 
                `&email=${encodeURIComponent(email)}` +
                `&phone=${encodeURIComponent(phone)}` +
                `&booking-id=${bookingId}`;
            }, 2000);
          }
        });
      }
      
      // Back button functionality
      const backBtn = document.getElementById('back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          window.history.back();
        });
      }
      
      // Clear validation errors on input
      const inputs = document.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          this.closest('.form-group')?.classList.remove('error');
          this.closest('.form-group')?.querySelector('.validation-message')?.textContent = '';
          
          if (this.id === 'terms') {
            document.getElementById('terms-error').textContent = '';
          }
        });
      });
      
      // Helper function to show notifications
      function showNotification(message, type = 'success') {
        // Create notification container if it doesn't exist
        let container = document.getElementById('notification-container');
        if (!container) {
          container = document.createElement('div');
          container.id = 'notification-container';
          document.body.appendChild(container);
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<p>${message}</p>`;
        
        // Add to container
        container.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
          notification.classList.add('fade-out');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 5000);
      }
      
      // Generate a unique booking ID
      function generateBookingId() {
        return Date.now().toString().slice(-6);
      }
      
      // Save booking to localStorage
      function saveBookingToLocalStorage(booking) {
        // Get existing bookings
        let bookings = [];
        try {
          bookings = JSON.parse(localStorage.getItem('calma_bookings') || '[]');
        } catch (e) {
          console.error('Error parsing bookings from localStorage:', e);
          bookings = [];
        }
        
        // Add new booking
        bookings.push(booking);
        
        // Save back to localStorage
        try {
          localStorage.setItem('calma_bookings', JSON.stringify(bookings));
        } catch (e) {
          console.error('Error saving bookings to localStorage:', e);
          showNotification('An error occurred while saving your booking. Please try again.', 'error');
        }
      }
      
      // Update admin stats
      function updateAdminStats() {
        try {
          // Get existing bookings
          const bookings = JSON.parse(localStorage.getItem('calma_bookings') || '[]');
          
          // Update total bookings count
          const totalBookingsElement = document.getElementById('total-bookings');
          if (totalBookingsElement) {
            totalBookingsElement.textContent = bookings.length;
          }
          
          // Count active bookings (pending or confirmed)
          const activeBookings = bookings.filter(b => b.status === 'pending' || b.status === 'confirmed').length;
          const activeBookingsElement = document.getElementById('active-bookings');
          if (activeBookingsElement) {
            activeBookingsElement.textContent = activeBookings;
          }
          
          // Count recent bookings (last 7 days)
          const sevenDaysAgo = new Date();
          sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
          const recentBookings = bookings.filter(b => new Date(b.created_at) >= sevenDaysAgo).length;
          const recentBookingsElement = document.getElementById('recent-bookings');
          if (recentBookingsElement) {
            recentBookingsElement.textContent = recentBookings;
          }
        } catch (e) {
          console.error('Error updating admin stats:', e);
        }
      }
    });
  </script>
</body>
</html>