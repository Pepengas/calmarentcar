document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("booking-form"),t=document.querySelectorAll(".form-group input, .form-group select"),o=document.querySelector(".mobile-menu"),n=document.querySelector(".nav-links"),r=document.querySelectorAll(".nav-links a"),a=document.querySelector(".booking-form"),s=document.querySelectorAll(".faq-item"),i=document.querySelector(".cars-grid"),c=document.getElementById("car-selection"),l=document.getElementById("pickup-date"),d=document.getElementById("dropoff-date"),u=document.querySelectorAll(".form-step"),m=document.querySelectorAll(".step"),f=document.querySelectorAll(".step-title"),p=document.getElementById("search-cars-btn"),h=document.getElementById("to-step-1");let v=1;const y=/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;function b(e){i&&(i.innerHTML="",0!==e.length?(e.forEach(e=>{const t=document.createElement("div");t.className="car-card";const o=e.image.startsWith("http")?e.image:`https://calmarental.com/${e.image}`;let n="";if(e.features&&e.features.length>0){n=`<ul class="car-features"><li>${e.features.flatMap(e=>e.split(",").map(e=>e.trim())).join("</li><li>")}</li></ul>`}t.innerHTML=`\n                <div class="car-image">\n                    <img src="${o}" alt="${e.name}" title="Photo of ${e.name}" loading="lazy" width="300" height="200">\n                </div>\n                <div class="car-details">\n                    <h3>${e.name}</h3>\n                    <p>${e.description}</p>\n                    ${n}\n                    <div class="car-pricing">\n                        <span class="price">From €${e.pricePerDay}/day</span>\n                        <span class="price-note">· Free cancellation</span>\n                    </div>\n                    <button class="btn btn-primary book-from-grid" data-car-id="${e.id}">Book Now</button>\n                </div>\n            `,i.appendChild(t)}),i.querySelectorAll(".book-from-grid").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("data-car-id");c&&(c.value=t,c.dispatchEvent(new Event("change")));const o=document.querySelector(".booking-form");o&&o.scrollIntoView({behavior:"smooth",block:"start"});const n=document.getElementById("pickup-location");n&&n.focus()})})):i.innerHTML="<p>No cars available at the moment.</p>")}async function g(){if(!(c&&l&&d&&p))return;const t=c.value,o=l.value,n=d.value;if(t&&o&&n){if(new Date(n)<new Date(o))return q("Drop-off date cannot be earlier than pickup date.","error"),void(p.disabled=!0);try{p.textContent="Checking...",p.disabled=!0;const e=await fetch(`https://calmarental.com/api/cars/availability?carId=${encodeURIComponent(t)}&pickupDate=${encodeURIComponent(o)}&dropoffDate=${encodeURIComponent(n)}`);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const r=await e.json();r.success&&r.available?(console.log(`Car ${t} is available from ${o} to ${n}`),q("Car is available for selected dates.","success",2e3),p.disabled=!1):(console.warn(`Car ${t} is NOT available from ${o} to ${n}`),q(r.message||"Selected car is not available for these dates.","error"),p.disabled=!0)}catch(e){console.error("Failed to check availability:",e),q("Could not check car availability. Please try again.","error"),p.disabled=!0}finally{p.textContent="Continue"}}else if("Checking..."!==p.textContent){const t=!!e.querySelector("#step-1 .form-group.error");p.disabled=t}}y&&(document.documentElement.classList.add("ios-device"),document.querySelectorAll('input[type="date"]').forEach(e=>{e.setAttribute("placeholder","YYYY-MM-DD"),e.addEventListener("focus",function(e){y&&(e.preventDefault(),this.click())})}),document.querySelectorAll('input[type="time"]').forEach(e=>{e.setAttribute("placeholder","HH:MM"),e.addEventListener("focus",function(e){y&&(e.preventDefault(),this.click())})}),document.addEventListener("touchmove",function(e){},{passive:!0})),async function(){const e=await async function(){try{const e=await fetch("https://calmarental.com/api/cars");if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.json()}catch(e){return console.error("Failed to fetch cars:",e),i&&(i.innerHTML='<p class="error-message">Failed to load car fleet. Please try refreshing.</p>'),c&&(c.innerHTML='<option value="" disabled selected>Failed to load cars</option>'),[]}}();b(e),function(e){if(!c)return;const t=c.querySelector("option[disabled]");c.innerHTML="",t&&c.appendChild(t),0===e.length&&t?t.textContent="No cars available":e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.name} - From €${e.pricePerDay}/day`,c.appendChild(t)})}(e)}(),c&&c.addEventListener("change",g),l&&l.addEventListener("change",g),d&&d.addEventListener("change",g),p&&p.addEventListener("click",function(){const e=document.querySelectorAll("#step-1 input[required], #step-1 select[required]");let t=!0;if(e.forEach(e=>{L(e)||(t=!1)}),t&&!p.disabled)k(2);else if(t&&p.disabled)q("Please select an available car and valid dates.","error");else{const e=document.querySelector("#step-1 .form-group.error input, #step-1 .form-group.error select");e&&e.focus(),q("Please complete all required fields in this step.","error")}}),h&&h.addEventListener("click",function(){k(1)});const E=document.querySelectorAll(".car-card");if(a&&(a.style.display="block",a.style.opacity="1"),E.length>0){const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(t.target.classList.add("card-visible"),e.unobserve(t.target))})},{threshold:.1,rootMargin:"0px 0px -50px 0px"});E.forEach(t=>{e.observe(t)})}function L(e){const t=e.name,o=e.value.trim(),n=e.closest(".form-group"),r=n?.querySelector(".validation-message");if(!n||!r)return!0;n.classList.remove("error","success"),r.textContent="",r.style.display="none";let a=!0,s="";if(e.hasAttribute("required")&&""===o&&(s="This field is required",a=!1),a&&""!==o)switch(t){case"pickup-date":case"dropoff-date":const e=new Date(o),n=new Date;if(n.setHours(0,0,0,0),e<n&&(s="Date cannot be in the past.",a=!1),"dropoff-date"===t){const e=document.getElementById("pickup-date")?.value;e&&new Date(o)<new Date(e)&&(s="Drop-off date cannot be before pickup date.",a=!1)}break;case"customer-email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)||(s="Please enter a valid email address.",a=!1);break;case"customer-phone":/^[+\d\s]{8,}$/.test(o)||(s="Please enter a valid phone number.",a=!1);break;case"age":const r=parseInt(o);(isNaN(r)||r<25||r>90)&&(s="Age must be between 25 and 90.",a=!1)}return a?function(e){e.classList.add("success"),e.classList.remove("error");const t=e.querySelector(".validation-message");t&&(t.textContent="",t.style.display="none")}(n):function(e,t,o){e.classList.add("error"),e.classList.remove("success"),t.textContent=o,t.style.display="block"}(n,r,s),a}function k(e){u.forEach(e=>{e.classList.remove("active")}),m.forEach(e=>{e.classList.remove("active"),e.classList.remove("completed")}),f.forEach(e=>{e.classList.remove("active")}),document.getElementById(`step-${e}`).classList.add("active");for(let t=1;t<=m.length;t++){const o=document.querySelector(`.step[data-step="${t}"]`),n=document.querySelector(`.step-title:nth-child(${t})`);t<e?o.classList.add("completed"):t===e&&(o.classList.add("active"),n.classList.add("active"))}v=e}function q(e,t="success",o=5e3){const n=document.createElement("div");n.className=`notification notification-${t}`,n.textContent=e;const r=document.createElement("button");r.innerHTML="&times;",r.className="close-button",r.onclick=()=>S(n),n.appendChild(r),document.body.appendChild(n);const a=setTimeout(()=>S(n),o);n.addEventListener("mouseover",()=>clearTimeout(a)),n.addEventListener("mouseleave",()=>setTimeout(()=>S(n),o))}function S(e){e&&document.body.contains(e)&&(e.classList.add("hide"),setTimeout(()=>{document.body.contains(e)&&document.body.removeChild(e)},500))}o.addEventListener("click",()=>{const e="true"===o.getAttribute("aria-expanded");n.classList.toggle("active"),o.setAttribute("aria-expanded",!e),e?(o.querySelector("i").classList.add("fa-bars"),o.querySelector("i").classList.remove("fa-times"),o.setAttribute("aria-label","Open navigation menu")):(o.querySelector("i").classList.remove("fa-bars"),o.querySelector("i").classList.add("fa-times"),o.setAttribute("aria-label","Close navigation menu"))}),document.addEventListener("keydown",function(e){if(window.innerWidth<=991&&n.classList.contains("active")){const t=n.querySelectorAll("a, button"),r=t[0],a=t[t.length-1];"Tab"===e.key&&(e.shiftKey&&document.activeElement===r?(e.preventDefault(),a.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),r.focus())),"Escape"===e.key&&(n.classList.remove("active"),o.setAttribute("aria-expanded","false"),o.querySelector("i").classList.add("fa-bars"),o.querySelector("i").classList.remove("fa-times"),o.focus())}}),r.forEach(e=>{e.addEventListener("click",function(e){if(this.getAttribute("href").startsWith("#")&&"#"!==this.getAttribute("href")){e.preventDefault();const t=this.getAttribute("href"),a=document.querySelector(t);a&&(n.classList.remove("active"),o.setAttribute("aria-expanded","false"),o.querySelector("i").classList.remove("fa-times"),o.querySelector("i").classList.add("fa-bars"),window.scrollTo({top:a.offsetTop-80,behavior:"smooth"}),r.forEach(e=>e.classList.remove("active")),this.classList.add("active"),a.setAttribute("tabindex","-1"),a.focus({preventScroll:!0}),setTimeout(()=>{a.removeAttribute("tabindex")},1e3))}})}),s.forEach(e=>{const t=e.querySelector(".faq-question"),o=e.querySelector(".faq-answer");t.setAttribute("aria-expanded","false"),o.setAttribute("aria-hidden","true"),t.addEventListener("click",()=>{const n=e.classList.contains("active");s.forEach(e=>{const t=e.querySelector(".faq-question"),o=e.querySelector(".faq-answer");e.classList.remove("active"),t.setAttribute("aria-expanded","false"),o.setAttribute("aria-hidden","true")}),n||(e.classList.add("active"),t.setAttribute("aria-expanded","true"),o.setAttribute("aria-hidden","false"))}),t.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())}),t.setAttribute("tabindex","0"),t.setAttribute("role","button")}),t.forEach(e=>{e.addEventListener("blur",function(){L(this)}),"SELECT"!==e.tagName&&"date"!==e.type&&"time"!==e.type||e.addEventListener("change",function(){L(this)})}),e&&e.addEventListener("submit",function(t){t.preventDefault();let o=!0;e.querySelectorAll("#step-2 [required]").forEach(e=>{L(e)||(o=!1)});if(e.querySelectorAll("#step-1 [required]").forEach(e=>{L(e)||(o=!1)}),p&&p.disabled&&(o=!1,q("Selected car or dates are unavailable.","error")),!o){const t=e.querySelector(".form-group.error input, .form-group.error select");return t&&t.focus(),void q("Please fill in all required fields correctly and ensure car is available.","error")}const n=new FormData(e),r={};n.forEach((e,t)=>{r[t]=e});const a=document.createElement("div");a.className="loading-indicator",a.innerHTML='<div class="spinner"></div><span>Processing...</span>',document.body.appendChild(a);const s=e.querySelector('button[type="submit"]');s&&(s.disabled=!0),fetch("https://calmarental.com/api/book",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).then(e=>e.ok?e.json():e.json().then(t=>{throw new Error(t.message||`HTTP error! Status: ${e.status}`)})).then(t=>{if(!t.success)throw new Error(t.message||"Backend reported an issue.");!function(){const e=document.getElementById("customer-email"),t=document.getElementById("car-selection"),o=document.getElementById("pickup-date"),n=document.getElementById("dropoff-date"),r=e?e.value:"your email",a=t?t.options[t.selectedIndex]:null,s=a?a.text.split(" - ")[0]:"selected vehicle",i=o?$(o.value):"",c=n?$(n.value):"",l=function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let o=0;o<8;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}(),d=document.getElementById("booking-form"),u=`\n            <div class="booking-success">\n                <div class="success-icon">\n                    <i class="fas fa-check-circle"></i>\n                </div>\n                <h2>Booking Request Successful!</h2>\n                <div class="booking-confirmation-message">\n                    <p>Thank you for your booking request. We've received your request for the <strong>${s}</strong>.</p>\n                    <p>Your booking reference: <strong>${l}</strong></p>\n                    <p>Vehicle: <strong>${s}</strong></p>\n                    ${i?`<p>Pick-up date: <strong>${i}</strong></p>`:""}\n                    ${c?`<p>Drop-off date: <strong>${c}</strong></p>`:""}\n                    <p>We've sent a confirmation email to <strong>${r}</strong> with all the details of your booking.</p>\n                    <p>If you have any questions, please contact our customer service.</p>\n                </div>\n                <button class="btn btn-primary" onclick="window.location.reload()">Make Another Booking</button>\n            </div>\n        `;d.innerHTML=u,window.scrollTo({top:0,behavior:"smooth"})}(),e.scrollIntoView({behavior:"smooth"})}).catch(e=>{console.error("Error submitting booking:",e),q(`Error: ${e.message}`,"error")}).finally(()=>{document.body.contains(a)&&document.body.removeChild(a)})}),window.addEventListener("scroll",function(){const e=window.scrollY;document.querySelectorAll("section[id]").forEach(t=>{const o=t.offsetTop-100,n=t.offsetHeight,a=t.getAttribute("id");if(e>=o&&e<o+n){r.forEach(e=>e.classList.remove("active"));const e=document.querySelector(`.nav-links a[href="#${a}"]`);e&&e.classList.add("active")}})});const w=document.querySelectorAll('input[type="date"]'),A=document.querySelectorAll('input[type="time"]');function $(e){if(!e)return"";return new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}w.forEach(e=>{e.addEventListener("click",function(t){if(t.preventDefault(),"function"==typeof e.showPicker)try{e.showPicker()}catch(t){console.error("Error showing date picker:",t),e.focus()}else e.focus()})}),A.forEach(e=>{e.addEventListener("click",function(t){if(t.preventDefault(),"function"==typeof e.showPicker)try{e.showPicker()}catch(t){console.error("Error showing time picker:",t),e.focus()}else e.focus()})});const C=document.getElementById("dev-notice");C&&"true"===localStorage.getItem("devNoticeClosed")&&C.classList.add("hidden")});