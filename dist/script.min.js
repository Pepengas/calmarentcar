(()=>{var m={init(){this.initMobileMenu(),this.initDarkModeToggle(),this.initFAQAccordion(),this.setupScrollEffects()},initMobileMenu(){let e=document.querySelector(".mobile-menu"),t=document.querySelector(".nav-links");e&&t&&(e.addEventListener("click",function(){t.classList.toggle("active"),e.classList.toggle("active");let a=e.classList.contains("active");e.setAttribute("aria-expanded",a);let i=e.querySelector("i");i&&(a?(i.classList.remove("fa-bars"),i.classList.add("fa-times")):(i.classList.remove("fa-times"),i.classList.add("fa-bars")))}),document.addEventListener("click",function(a){let i=t.contains(a.target),n=e.contains(a.target);if(!i&&!n&&t.classList.contains("active")){t.classList.remove("active"),e.classList.remove("active"),e.setAttribute("aria-expanded",!1);let s=e.querySelector("i");s&&(s.classList.remove("fa-times"),s.classList.add("fa-bars"))}}),document.querySelectorAll(".nav-links a").forEach(a=>{a.addEventListener("click",function(){t.classList.remove("active"),e.classList.remove("active"),e.setAttribute("aria-expanded",!1);let i=e.querySelector("i");i&&(i.classList.remove("fa-times"),i.classList.add("fa-bars"))})}))},initDarkModeToggle(){let e=document.getElementById("dark-mode-toggle");if(e){let t=localStorage.getItem("darkMode"),o=window.matchMedia("(prefers-color-scheme: dark)").matches;(t==="dark"||t===null&&o)&&(document.body.classList.add("dark-mode"),e.checked=!0),e.addEventListener("change",function(){this.checked?(document.body.classList.add("dark-mode"),localStorage.setItem("darkMode","dark")):(document.body.classList.remove("dark-mode"),localStorage.setItem("darkMode","light"))})}},initFAQAccordion(){let e=document.querySelectorAll(".faq-item");if(e.length>0){e.forEach(i=>{let n=i.querySelector(".faq-header");n.addEventListener("click",()=>{e.forEach(r=>{if(r!==i&&r.classList.contains("active")){r.classList.remove("active");let d=r.querySelector(".faq-content");d.style.maxHeight=null;let l=r.querySelector(".faq-toggle");l&&l.setAttribute("aria-expanded","false")}}),i.classList.toggle("active");let s=i.querySelector(".faq-content");i.classList.contains("active")?(s.style.maxHeight=s.scrollHeight+"px",n.querySelector(".faq-toggle").setAttribute("aria-expanded","true")):(s.style.maxHeight=null,n.querySelector(".faq-toggle").setAttribute("aria-expanded","false"))})});let t=e[0],o=t.querySelector(".faq-content"),a=t.querySelector(".faq-toggle");t.classList.add("active"),o.style.maxHeight=o.scrollHeight+"px",a&&a.setAttribute("aria-expanded","true")}},setupScrollEffects(){let e=document.querySelector(".site-header");e&&window.addEventListener("scroll",function(){window.scrollY>50?e.classList.add("scrolled"):e.classList.remove("scrolled")}),document.querySelectorAll('a[href^="#"]:not(a[href="#"])').forEach(o=>{o.addEventListener("click",function(a){a.preventDefault();let i=document.querySelector(this.getAttribute("href"));i&&i.scrollIntoView({behavior:"smooth",block:"start"})})})}};function c(e,t="success",o=5e3){let a=document.querySelector(".notification-container");a||(a=document.createElement("div"),a.className="notification-container",document.body.appendChild(a));let i=document.createElement("div");i.className=`notification ${t}`,i.setAttribute("role","alert");let n="fa-info-circle";t==="success"&&(n="fa-check-circle"),t==="error"&&(n="fa-exclamation-circle"),t==="warning"&&(n="fa-exclamation-triangle"),i.innerHTML=`
        <i class="fas ${n}"></i>
        <p>${e}</p>
        <button class="close-btn" aria-label="Close notification">
            <i class="fas fa-times"></i>
        </button>
    `,a.appendChild(i);let s=i.querySelector(".close-btn");return s&&s.addEventListener("click",function(){f(i)}),setTimeout(()=>{f(i)},o),i}function f(e){e.classList.add("hiding"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}var p={production:"https://calmarentcar-production.up.railway.app",development:"http://localhost:3000"},b=window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1",u=b?p.production:p.development;var h={carGrid:null,carSelectionDropdown:null,cars:[],async init(){this.carGrid=document.querySelector(".cars-grid"),this.carSelectionDropdown=document.getElementById("car-selection"),await this.loadCars()},async loadCars(){try{this.cars=await this.fetchCars(),this.displayCars(this.cars),this.populateCarDropdown(this.cars)}catch(e){console.error("Error loading cars:",e),c("Failed to load car fleet. Please try refreshing.","error")}},async fetchCars(){try{let e=await fetch(`${u}/api/cars`);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.json()}catch(e){return console.error("Failed to fetch cars:",e),this.carGrid&&(this.carGrid.innerHTML='<p class="error-message">Failed to load car fleet. Please try refreshing.</p>'),this.carSelectionDropdown&&(this.carSelectionDropdown.innerHTML='<option value="" disabled selected>Failed to load cars</option>'),[]}},displayCars(e){if(this.carGrid){if(this.carGrid.innerHTML="",e.length===0){this.carGrid.innerHTML="<p>No cars available at the moment.</p>";return}e.forEach(t=>{let o=document.createElement("div");o.className="car-card";let a=t.image.startsWith("http")?t.image:`${u}/${t.image}`,i="";t.features&&t.features.length>0&&(i=`<ul class="car-features"><li>${t.features.join("</li><li>")}</li></ul>`),o.innerHTML=`
                <div class="car-image">
                    <img src="${a}" alt="${t.name}" loading="lazy" width="300" height="200">
                </div>
                <div class="car-details">
                    <h3>${t.name}</h3>
                    <p>${t.description}</p>
                    ${i}
                    <div class="car-pricing">
                        <span class="price">From \u20AC${t.pricePerDay}/day</span>
                        <span class="price-note">\xB7 Free cancellation</span>
                    </div>
                    <button class="btn btn-primary book-from-grid" data-car-id="${t.id}">Book Now</button>
                </div>
            `,this.carGrid.appendChild(o)}),this.addGridBookNowListeners()}},populateCarDropdown(e){if(!this.carSelectionDropdown)return;let t=this.carSelectionDropdown.querySelector("option[disabled]");if(this.carSelectionDropdown.innerHTML="",t&&this.carSelectionDropdown.appendChild(t),e.length===0&&t){t.textContent="No cars available";return}e.forEach(o=>{let a=document.createElement("option");a.value=o.id,a.textContent=`${o.name} - From \u20AC${o.pricePerDay}/day`,this.carSelectionDropdown.appendChild(a)})},addGridBookNowListeners(){if(!this.carGrid)return;this.carGrid.querySelectorAll(".book-from-grid").forEach(t=>{t.addEventListener("click",o=>{o.preventDefault();let a=t.getAttribute("data-car-id");this.carSelectionDropdown&&(this.carSelectionDropdown.value=a,this.carSelectionDropdown.dispatchEvent(new Event("change")));let i=document.querySelector(".booking-form");i&&i.scrollIntoView({behavior:"smooth",block:"start"});let n=document.getElementById("pickup-location");n&&n.focus()})})},getCarById(e){return this.cars.find(t=>t.id===e)}};var g={formSteps:null,steps:null,stepTitles:null,nextBtn:null,prevBtn:null,currentStep:1,bookingForm:null,init(){this.bookingForm=document.getElementById("booking-form"),this.bookingForm&&(this.formSteps=document.querySelectorAll(".form-step"),this.steps=document.querySelectorAll(".step"),this.stepTitles=document.querySelectorAll(".step-title"),this.nextBtn=document.getElementById("to-step-2"),this.prevBtn=document.getElementById("to-step-1"),this.setupFormValidation(),this.setupStepNavigation(),this.setupAvailabilityCheck(),this.setupFormSubmission())},setupFormValidation(){if(!this.bookingForm)return;this.bookingForm.querySelectorAll(".form-group input, .form-group select").forEach(t=>{t.addEventListener("blur",()=>this.validateField(t)),t.addEventListener("input",()=>this.validateField(t)),t.addEventListener("change",()=>this.validateField(t))})},setupStepNavigation(){!this.nextBtn||!this.prevBtn||(this.nextBtn.addEventListener("click",()=>{let e=document.querySelectorAll("#step-1 input[required], #step-1 select[required]"),t=!0;if(e.forEach(o=>{this.validateField(o)||(t=!1)}),t&&!this.nextBtn.disabled)this.goToStep(2);else if(t&&this.nextBtn.disabled)c("Please select an available car and valid dates.","error");else{let o=document.querySelector("#step-1 .form-group.error input, #step-1 .form-group.error select");o&&o.focus(),c("Please complete all required fields in this step.","error")}}),this.prevBtn.addEventListener("click",()=>{this.goToStep(1)}))},setupAvailabilityCheck(){let e=document.getElementById("car-selection"),t=document.getElementById("pickup-date"),o=document.getElementById("dropoff-date");e&&e.addEventListener("change",()=>this.checkAvailability()),t&&t.addEventListener("change",()=>this.checkAvailability()),o&&o.addEventListener("change",()=>this.checkAvailability())},setupFormSubmission(){this.bookingForm&&this.bookingForm.addEventListener("submit",async e=>{e.preventDefault();let t=this.bookingForm.querySelectorAll("input[required], select[required]"),o=!0;if(t.forEach(s=>{this.validateField(s)||(o=!1)}),!o){c("Please complete all required fields correctly.","error");return}let a=new FormData(this.bookingForm),i={};for(let[s,r]of a.entries())i[s]=r;let n=this.bookingForm.querySelector('button[type="submit"]');n&&(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...');try{let s=await fetch(`${u}/api/book`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),r=await s.json();s.ok&&r.success?this.showBookingSuccess(r):c(r.message||"An error occurred while processing your booking.","error")}catch(s){console.error("Booking error:",s),c("There was a problem submitting your booking. Please try again later.","error")}finally{n&&(n.disabled=!1,n.innerHTML='Complete Booking <i class="fas fa-arrow-right"></i>')}})},async checkAvailability(){let e=document.getElementById("car-selection"),t=document.getElementById("pickup-date"),o=document.getElementById("dropoff-date");if(!e||!t||!o||!this.nextBtn)return;let a=e.value,i=t.value,n=o.value;if(a&&i&&n){if(new Date(n)<new Date(i)){c("Drop-off date cannot be earlier than pickup date.","error"),this.nextBtn.disabled=!0;return}try{this.nextBtn.textContent="Checking...",this.nextBtn.disabled=!0;let s=await fetch(`${u}/api/cars/availability?carId=${encodeURIComponent(a)}&pickupDate=${encodeURIComponent(i)}&dropoffDate=${encodeURIComponent(n)}`);if(!s.ok)throw new Error(`HTTP error! Status: ${s.status}`);let r=await s.json();r.success&&r.available?(console.log(`Car ${a} is available from ${i} to ${n}`),c("Car is available for selected dates.","success",2e3),this.nextBtn.disabled=!1):(console.warn(`Car ${a} is NOT available from ${i} to ${n}`),c(r.message||"Selected car is not available for these dates.","error"),this.nextBtn.disabled=!0)}catch(s){console.error("Failed to check availability:",s),c("Could not check car availability. Please try again.","error"),this.nextBtn.disabled=!0}finally{this.nextBtn.textContent="Continue"}}else if(this.nextBtn.textContent!=="Checking..."){let s=!!this.bookingForm.querySelector("#step-1 .form-group.error");this.nextBtn.disabled=s}},validateField(e){if(!e)return!0;let t=e.closest(".form-group");if(!t)return!0;let o=t.querySelector(".error-message"),a=!0,i="";if(t.classList.remove("error","success"),o&&(o.textContent=""),!e.hasAttribute("required")&&e.value.trim()==="")return!0;if(e.hasAttribute("required")&&e.value.trim()==="")a=!1,i="This field is required";else switch(e.type){case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.value)||(a=!1,i="Please enter a valid email address");break;case"tel":/^[+]?[\s./0-9()-]+$/.test(e.value)||(a=!1,i="Please enter a valid phone number");break;case"number":e.id==="age"&&parseInt(e.value)<25&&(a=!1,i="You must be at least 25 years old to rent a car");break;case"date":let r=new Date(e.value),d=new Date;if(d.setHours(0,0,0,0),r<d&&(a=!1,i="Date cannot be in the past"),e.id==="dropoff-date"){let l=document.getElementById("pickup-date");if(l&&l.value){let v=new Date(l.value);r<v&&(a=!1,i="Drop-off date cannot be earlier than pickup date")}}break}return e.id==="customer-name"&&e.value.trim().length<3&&(a=!1,i="Name must be at least 3 characters"),a?this.showSuccess(t):this.showError(t,o,i),a},showError(e,t,o){e.classList.add("error"),e.classList.remove("success"),t&&(t.textContent=o)},showSuccess(e){e.classList.remove("error"),e.classList.add("success")},goToStep(e){e<1||e>this.formSteps.length||(this.currentStep=e,this.formSteps.forEach((t,o)=>{o+1===e?t.classList.add("active"):t.classList.remove("active")}),this.steps.forEach((t,o)=>{o+1===e?t.classList.add("active"):o+1<e?(t.classList.add("completed"),t.classList.remove("active")):t.classList.remove("completed","active")}),this.stepTitles.forEach((t,o)=>{o+1===e?t.classList.add("active"):t.classList.remove("active")}),this.bookingForm.scrollIntoView({behavior:"smooth",block:"start"}))},showBookingSuccess(e){if(!this.bookingForm)return;let t=this.getCarName(document.getElementById("car-selection").value),o=document.getElementById("pickup-location").value,a=document.getElementById("dropoff-location").value,i=document.getElementById("pickup-date").value,n=document.getElementById("dropoff-date").value,s=document.getElementById("customer-name").value,r=e.booking_id||this.generateBookingReference(),d=`
            <div class="booking-success">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Booking Confirmed!</h3>
                <p>Thank you, ${s}. Your car rental has been successfully booked.</p>
                
                <div class="booking-details">
                    <div class="detail-item">
                        <span class="detail-label">Booking Reference:</span>
                        <span class="detail-value">${r}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Car:</span>
                        <span class="detail-value">${t}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Pick-up:</span>
                        <span class="detail-value">${this.formatDisplayDate(i)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Drop-off:</span>
                        <span class="detail-value">${this.formatDisplayDate(n)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value">${o}</span>
                    </div>
                </div>
                
                <p class="confirmation-message">A confirmation email has been sent to your email address.</p>
                
                <button class="btn btn-primary" id="new-booking-btn">Make Another Booking</button>
            </div>
        `;this.bookingForm.innerHTML=d;let l=document.getElementById("new-booking-btn");l&&l.addEventListener("click",()=>{window.location.reload()}),this.bookingForm.scrollIntoView({behavior:"smooth",block:"start"})},getCarName(e){let t=document.getElementById("car-selection");if(t){let o=t.querySelector(`option[value="${e}"]`);return o?o.textContent.split("-")[0].trim():"Selected car"}return"Selected car"},formatDisplayDate(e){let t=new Date(e),o={weekday:"short",year:"numeric",month:"short",day:"numeric"};return t.toLocaleDateString("en-US",o)},generateBookingReference(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t="";for(let o=0;o<8;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}};document.addEventListener("DOMContentLoaded",async function(){try{m.init(),await h.init(),g.init(),console.log("Calma Car Rental application initialized")}catch(e){console.error("Error initializing application:",e)}});})();
